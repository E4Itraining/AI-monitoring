# =============================================================================
# Fluent-bit - Scalable Configuration
# =============================================================================
# Dual output: OpenSearch (full-text) + OpenObserve (unified)
# =============================================================================

[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On
    HC_Errors_Count 5
    HC_Retry_Failure_Count 5
    HC_Period     60
    # Storage buffering for reliability
    storage.path              /tmp/fluent-bit-storage/
    storage.sync              normal
    storage.checksum          off
    storage.backlog.mem_limit 50M

# =============================================================================
# INPUT: Application JSON Logs
# =============================================================================
[INPUT]
    Name              tail
    Tag               ai.app
    Path              /logs/app.log
    Parser            json_log
    Refresh_Interval  5
    Rotate_Wait       30
    Mem_Buf_Limit     10MB
    Skip_Long_Lines   On
    DB                /tmp/fluent-bit-app.db
    DB.locking        true
    storage.type      filesystem

# =============================================================================
# INPUT: Docker Container Logs (optional)
# =============================================================================
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Refresh_Interval  10
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /tmp/fluent-bit-docker.db
    storage.type      memory

# =============================================================================
# FILTER: Add Kubernetes-style metadata
# =============================================================================
[FILTER]
    Name          record_modifier
    Match         ai.*
    Record        platform ai-monitoring
    Record        environment production
    Record        cluster local

# =============================================================================
# FILTER: Enrich with timestamp if missing
# =============================================================================
[FILTER]
    Name          lua
    Match         ai.*
    Script        /fluent-bit/etc/enrich.lua
    Call          enrich_log

# =============================================================================
# FILTER: Detect log level from message
# =============================================================================
[FILTER]
    Name          modify
    Match         ai.*
    Condition     Key_Does_Not_Exist level
    Set           level INFO

# =============================================================================
# FILTER: Parse nested JSON in message field
# =============================================================================
[FILTER]
    Name          parser
    Match         ai.*
    Key_Name      message
    Parser        json_nested
    Reserve_Data  True
    Preserve_Key  True

# =============================================================================
# OUTPUT: OpenSearch (Primary - Full-text search)
# =============================================================================
[OUTPUT]
    Name               opensearch
    Match              ai.*
    Host               opensearch
    Port               9200
    Index              ai-logs
    Type               _doc
    Logstash_Format    On
    Logstash_Prefix    ai-logs
    Logstash_DateFormat %Y.%m.%d
    Time_Key           @timestamp
    Time_Key_Format    %Y-%m-%dT%H:%M:%S.%L
    Include_Tag_Key    On
    Tag_Key            fluentbit_tag
    Generate_ID        On
    Replace_Dots       On
    Suppress_Type_Name On
    Buffer_Size        5MB
    Retry_Limit        5
    # TLS disabled for local dev
    tls                Off
    tls.verify         Off

# =============================================================================
# OUTPUT: OpenObserve (Secondary - Unified platform)
# =============================================================================
[OUTPUT]
    Name               http
    Match              ai.*
    Host               openobserve
    Port               5080
    URI                /api/default/ai-logs/_json
    Format             json
    Json_Date_Key      @timestamp
    Json_Date_Format   iso8601
    HTTP_User          admin@ai-monitoring.local
    HTTP_Passwd        ComplexPass123!
    tls                Off
    Retry_Limit        5

# =============================================================================
# OUTPUT: Stdout (Debug - comment in production)
# =============================================================================
# [OUTPUT]
#     Name               stdout
#     Match              *
#     Format             json_lines

# =============================================================================
# OUTPUT: Prometheus metrics exposition
# =============================================================================
[OUTPUT]
    Name               prometheus_exporter
    Match              internal_metrics
    Host               0.0.0.0
    Port               2021
